---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.1
  name: sparksessionpools.sparkinteractive.io
spec:
  group: sparkinteractive.io
  names:
    kind: SparkSessionPool
    listKind: SparkSessionPoolList
    plural: sparksessionpools
    singular: sparksessionpool
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.type
      name: Type
      type: string
    - jsonPath: .spec.host
      name: Host
      type: string
    - jsonPath: .status.currentReplicas
      name: Replicas
      type: integer
    - jsonPath: .status.readyReplicas
      name: Ready
      type: integer
    - jsonPath: .status.totalActiveSessions
      name: Sessions
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: SparkSessionPool is the Schema for the sparksessionpools API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: SparkSessionPoolSpec defines the desired state of a pool
              of Spark server instances
            properties:
              host:
                description: |-
                  Host is the hostname for routing traffic to this pool.
                  The controller auto-creates an Ingress for this hostname.
                  For connect pools, the proxy routes by gRPC :authority header.
                minLength: 1
                type: string
              replicas:
                description: Replicas defines min/max pool size
                properties:
                  max:
                    default: 10
                    description: Maximum number of pool instances
                    format: int32
                    minimum: 1
                    type: integer
                  min:
                    default: 1
                    description: Minimum number of pool instances (always running)
                    format: int32
                    minimum: 1
                    type: integer
                required:
                - max
                - min
                type: object
              scaling:
                description: Scaling defines autoscaling behavior
                properties:
                  cooldownSeconds:
                    default: 300
                    description: CooldownSeconds - minimum time between scaling actions
                    format: int32
                    type: integer
                  drainBeforeScaleDown:
                    default: true
                    description: DrainBeforeScaleDown - if true, stop routing new
                      sessions before removing instance
                    type: boolean
                  metrics:
                    description: Metrics defines what metrics drive scaling decisions
                    properties:
                      targetPerInstance:
                        default: 20
                        description: |-
                          TargetPerInstance - target value per instance for the primary metric.
                            activeSessions: target session count per instance (default 20)
                            cpu: target CPU utilization percentage 0-100 (default 80)
                            memory: target memory utilization percentage 0-100 (default 80)
                        format: int32
                        type: integer
                      type:
                        default: activeSessions
                        description: Primary metric for scaling (activeSessions, cpu,
                          memory)
                        enum:
                        - activeSessions
                        - cpu
                        - memory
                        type: string
                    required:
                    - targetPerInstance
                    - type
                    type: object
                  scaleDownThreshold:
                    default: "0.3"
                    description: ScaleDownThreshold - when load drops below this fraction
                      of target, scale down
                    type: string
                  scaleUpThreshold:
                    default: "0.8"
                    description: ScaleUpThreshold - when load exceeds this fraction
                      of target, scale up
                    type: string
                required:
                - metrics
                type: object
              sessionPolicy:
                description: SessionPolicy defines session management rules
                properties:
                  defaultSessionConf:
                    additionalProperties:
                      type: string
                    description: DefaultSessionConf - default Spark configs applied
                      to each session
                    type: object
                  idleTimeoutMinutes:
                    default: 720
                    description: IdleTimeoutMinutes - kill sessions idle longer than
                      this
                    format: int32
                    type: integer
                  maxSessionsPerUser:
                    default: 5
                    description: MaxSessionsPerUser - default max concurrent sessions
                      per user
                    format: int32
                    type: integer
                  maxTotalSessions:
                    default: 200
                    description: MaxTotalSessions - max total sessions across the
                      pool
                    format: int32
                    type: integer
                  quotas:
                    description: Quotas - per-user or per-group overrides
                    items:
                      properties:
                        match:
                          description: Match defines which users/groups this quota
                            applies to
                          properties:
                            groups:
                              description: Groups to match (from OIDC token claims)
                              items:
                                type: string
                              type: array
                            users:
                              description: Users to match
                              items:
                                type: string
                              type: array
                          type: object
                        maxSessionsPerUser:
                          description: MaxSessionsPerUser overrides the pool-level
                            default
                          format: int32
                          type: integer
                        sessionConf:
                          additionalProperties:
                            type: string
                          description: SessionConf overrides default session spark
                            configs
                          type: object
                      required:
                      - match
                      type: object
                    type: array
                type: object
              sparkApplicationTemplate:
                description: |-
                  Template for creating SparkApplication instances
                  This is the raw SparkApplication spec that will be used as a template
                properties:
                  spec:
                    description: |-
                      Spec is the raw SparkApplication spec stored as embedded JSON.
                      We use apiextensionsv1.JSON to avoid importing the full SparkOperator types.
                    x-kubernetes-preserve-unknown-fields: true
                required:
                - spec
                type: object
              type:
                description: 'Type of Spark server: "connect" or "thrift"'
                enum:
                - connect
                - thrift
                type: string
            required:
            - host
            - replicas
            - scaling
            - sessionPolicy
            - sparkApplicationTemplate
            - type
            type: object
          status:
            description: SparkSessionPoolStatus defines the observed state of SparkSessionPool
            properties:
              conditions:
                description: Conditions
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              currentReplicas:
                description: CurrentReplicas - number of running instances
                format: int32
                type: integer
              instances:
                description: Instances tracks the state of each pool instance
                items:
                  properties:
                    activeSessions:
                      description: ActiveSessions on this instance
                      format: int32
                      type: integer
                    endpoint:
                      description: Endpoint for client connections
                      type: string
                    name:
                      description: Name of the SparkApplication CR
                      type: string
                    sparkApplicationState:
                      description: SparkApplicationState from the SparkOperator
                      type: string
                    state:
                      description: State of the instance
                      enum:
                      - Pending
                      - Running
                      - Draining
                      - Failed
                      - Terminated
                      type: string
                  required:
                  - activeSessions
                  - name
                  - state
                  type: object
                type: array
              lastScaleTime:
                description: LastScaleTime - timestamp of last scaling action
                format: date-time
                type: string
              readyReplicas:
                description: ReadyReplicas - number of instances ready to accept sessions
                format: int32
                type: integer
              totalActiveSessions:
                description: TotalActiveSessions across all instances
                format: int32
                type: integer
            required:
            - currentReplicas
            - readyReplicas
            - totalActiveSessions
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
